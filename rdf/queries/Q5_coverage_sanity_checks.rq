# File: kg/queries/Q5_coverage_sanity_checks.rq
# Purpose: Q5 â€” Coverage sanity checks: missing volume / missing subject / missing place
# Tale typing is constrained to CIDOC-CRM E33.
# Place predicate: default is dcterms:spatial; if we use rft:recordingPlace / rft:recordingParish,
# switch the FILTER NOT EXISTS block accordingly.

PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX crm:     <http://www.cidoc-crm.org/cidoc-crm/>

SELECT ?metric (COUNT(DISTINCT ?tale) AS ?count)
WHERE {
  {
    BIND("missing_volume" AS ?metric)
    ?tale a crm:E33_Linguistic_Object .
    FILTER NOT EXISTS { ?tale dcterms:isPartOf ?v . }
  }
  UNION
  {
    BIND("missing_subject" AS ?metric)
    ?tale a crm:E33_Linguistic_Object .
    FILTER NOT EXISTS { ?tale dcterms:subject ?s . }
  }
  UNION
  {
    BIND("missing_place" AS ?metric)
    ?tale a crm:E33_Linguistic_Object .

    # Option A (default):
    FILTER NOT EXISTS { ?tale dcterms:spatial ?p . }

    # Option B (if you model place with project predicates):
    # FILTER NOT EXISTS { ?tale <https://github.com/eugeniavd/magic_tagger/rdf/ontology/#recordingPlace> ?p . }
    # FILTER NOT EXISTS { ?tale <https://github.com/eugeniavd/magic_tagger/rdf/ontology/#recordingParish> ?p . }
  }
}
GROUP BY ?metric
ORDER BY ?metric
